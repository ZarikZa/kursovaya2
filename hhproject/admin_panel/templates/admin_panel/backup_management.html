{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title_name %}Управление бэкапами - Админ панель{% endblock %}

{% block style %}
        {% include '_inc/style.html' %}
        {% include '_inc/style_admin.html' %}
    {% endblock %}

{% block admin_content %}
<div class="admin-content-header">
    <h1>Управление бэкапами</h1>
    <p>Создание и восстановление резервных копий</p>
</div>

{% if pending_restore %}
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Подтверждение восстановления</h3>
    </div>
    <div class="admin-card-body">
        <div class="alert alert-warning">
            <strong>Внимание!</strong> Вы собираетесь восстановить базу данных из бэкапа "{{ pending_restore.name }}". 
            Это действие перезапишет все текущие данные.
        </div>
        <div class="confirmation-actions">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="backup_id" value="{{ pending_restore.id }}">
                <input type="hidden" name="confirm_restore" value="1">
                <button type="submit" class="btn-admin btn-admin-danger">
                    Подтвердить восстановление
                </button>
                <a href="{% url 'admin_cancel_restore' %}" class="btn-admin btn-admin-primary">
                    Отмена
                </a>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Создание бэкапа -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Создание бэкапа</h3>
    </div>
    <div class="admin-card-body">
        <form method="post">
            {% csrf_token %}
            <div class="admin-form-group">
                <label class="admin-form-label">Тип бэкапа:</label>
                <select name="backup_type" class="admin-form-control">
                    {% for type_value, type_label in backup_types %}
                    <option value="{{ type_value }}">{{ type_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" name="create_backup" class="btn-admin btn-admin-success">
                Создать бэкап
            </button>
        </form>
    </div>
</div>

<!-- Загрузка бэкапа -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Загрузка бэкапа</h3>
    </div>
    <div class="admin-card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="admin-form-group">
                <label class="admin-form-label">Файл бэкапа:</label>
                {{ form.backup_file }}
            </div>
            <button type="submit" name="upload_backup" class="btn-admin btn-admin-primary">
                Загрузить бэкап
            </button>
        </form>
    </div>
</div>

<!-- Статистика базы данных -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Статистика базы данных</h3>
    </div>
    <div class="admin-card-body">
        <form method="post" class="mb-3">
            {% csrf_token %}
            <button type="submit" name="get_stats" class="btn-admin btn-admin-info">
                Обновить статистику
            </button>
        </form>
        
        {% if db_stats %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Таблица</th>
                        <th>Записей</th>
                        <th>Размер таблицы</th>
                        <th>Размер индексов</th>
                        <th>Общий размер</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in db_stats %}
                    <tr>
                        <td>{{ stat.table_name }}</td>
                        <td>{{ stat.row_count }}</td>
                        <td>{{ stat.table_size }}</td>
                        <td>{{ stat.index_size }}</td>
                        <td>{{ stat.total_size }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">Нажмите "Обновить статистику" для получения данных</p>
        {% endif %}
    </div>
</div>

<!-- Список бэкапов -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Список бэкапов</h3>
    </div>
    <div class="admin-card-body">
        {% if backups %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Тип</th>
                        <th>Размер</th>
                        <th>Дата создания</th>
                        <th>Создан</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr>
                        <td>{{ backup.name }}</td>
                        <td>
                            <span class="badge">{{ backup.get_backup_type_display }}</span>
                        </td>
                        <td>{{ backup.get_file_size_display }}</td>
                        <td>{{ backup.created_at|date:"d.m.Y H:i" }}</td>
                        <td>{{ backup.created_by.username }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'admin_download_backup' backup.id %}" class="btn-admin btn-admin-primary btn-admin-sm">
                                    Скачать
                                </a>
                                <form method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="backup_id" value="{{ backup.id }}">
                                    <button type="submit" name="restore_backup" class="btn-admin btn-admin-warning btn-admin-sm">
                                        Восстановить
                                    </button>
                                </form>
                                <a href="{% url 'admin_delete_backup' backup.id %}" class="btn-admin btn-admin-danger btn-admin-sm" 
                                   onclick="return confirm('Вы уверены что хотите удалить этот бэкап?')">
                                    Удалить
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">Нет созданных бэкапов</p>
        {% endif %}
    </div>
</div>

<!-- Тестирование процедур -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3>Тестирование процедур базы данных</h3>
    </div>
    <div class="admin-card-body">
        {% if procedure_tests %}
        <div class="procedure-tests">
            {% for test in procedure_tests %}
            <div class="test-item">
                <strong>{{ test.procedure }}:</strong>
                <span class="status-{{ test.status|lower }}">{{ test.status }}</span>
                <div class="test-result">{{ test.result }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">Не удалось проверить процедуры базы данных</p>
        {% endif %}
    </div>
</div>

<style>
.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #f59e0b;
}

.confirmation-actions {
    display: flex;
    gap: 10px;
}

.procedure-tests {
    display: grid;
    gap: 15px;
}

.test-item {
    padding: 15px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

.status-ok {
    color: #10b981;
    font-weight: 600;
}

.status-failed {
    color: #ef4444;
    font-weight: 600;
}

.test-result {
    margin-top: 5px;
    color: #cbd5e1;
    font-size: 0.9rem;
}

.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}
</style>
{% endblock %}